<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Location Viewer</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body{
  margin:0;
  background:#111;
  color:#eee;
  font-family:Arial;
}
#top{
  padding:10px;
  text-align:center;
}
#map{
  height:85vh;
}
</style>
</head>

<body>

<div id="top">
<h3>üó∫Ô∏è LOCATION VIEWER</h3>
Pair Code:
<input id="pair" placeholder="Enter pair code">
<p id="info">Waiting for location‚Ä¶</p>
</div>

<div id="map"></div>

<script>
const ws = new WebSocket("wss://ws-relay-zqzk.onrender.com");

// üîë restore saved pair code
const savedPair = localStorage.getItem("pairCode");
if (savedPair) {
  document.getElementById("pair").value = savedPair;
}

let map = L.map("map").setView([20,78], 5);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{
  maxZoom:19,
  attribution:"¬© OpenStreetMap"
}).addTo(map);

let marker=null, circle=null;

ws.onmessage = e => {
  const d = JSON.parse(e.data);
  const pair = document.getElementById("pair").value.trim();

  if(!pair || d.pair !== pair) return;

  // üíæ remember successful pair code
  localStorage.setItem("pairCode", pair);

  if(!marker){
    marker = L.marker([d.lat, d.lon]).addTo(map);
    circle = L.circle([d.lat, d.lon],{
      radius: d.acc,
      color: "red",
      fillOpacity: 0.2
    }).addTo(map);
  }else{
    marker.setLatLng([d.lat, d.lon]);
    circle.setLatLng([d.lat, d.lon]);
  }

  map.setView([d.lat, d.lon], 13);

  document.getElementById("info").innerText =
    (d.city || "") + " " + (d.region || "") +
    " | " + new Date(d.ts).toLocaleTimeString();
};
</script>

</body>
</html>
