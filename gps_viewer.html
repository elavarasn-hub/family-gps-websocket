<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>GPS Viewer</title>

<!-- OpenStreetMap + Leaflet (FREE) -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #111;
  color: #eee;
  text-align: center;
  padding: 20px;
}

input {
  padding: 10px;
  font-size: 18px;
  text-align: center;
  border-radius: 8px;
  border: none;
  width: 180px;
}

#status {
  margin-top: 10px;
  color: #aaa;
}

#distance {
  margin-top: 8px;
  font-size: 18px;
  color: #0f0;
}

#map {
  width: 100%;
  height: 350px;
  margin-top: 15px;
  border-radius: 12px;
  display: none;
}
</style>
</head>

<body>

<h1>üëÄ GPS Viewer</h1>

<p>Pair Code:</p>
<input id="pairId" value="AB1234" />

<div id="status">Waiting for data‚Ä¶</div>
<div id="distance"></div>

<div id="map"></div>

<script>
/* ===============================
   WEBSOCKET
================================ */
const ws = new WebSocket("wss://ws-relay-zqzk.onrender.com");

/* ===============================
   MAP VARIABLES
================================ */
let map = null;
let senderMarker = null;

/* ===============================
   MAP INIT
================================ */
function initMap(lat, lon) {
  map = L.map("map").setView([lat, lon], 16);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "¬© OpenStreetMap contributors"
  }).addTo(map);

  senderMarker = L.marker([lat, lon])
    .addTo(map)
    .bindPopup("Sender Location")
    .openPopup();

  document.getElementById("map").style.display = "block";
}

/* ===============================
   DISTANCE CALCULATION
================================ */
function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371e3;
  const œÜ1 = lat1 * Math.PI / 180;
  const œÜ2 = lat2 * Math.PI / 180;
  const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
  const ŒîŒª = (lon2 - lon1) * Math.PI / 180;

  const a =
    Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +
    Math.cos(œÜ1) * Math.cos(œÜ2) *
    Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);

  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}

/* ===============================
   RECEIVE DATA
================================ */
ws.onmessage = (e) => {
  try {
    const data = JSON.parse(e.data);
    const pair = document.getElementById("pairId").value.trim();

    if (data.type !== "location") return;
    if (data.pairId !== pair) return;

    document.getElementById("status").innerText =
      `üì° Live from sender (${data.lat.toFixed(5)}, ${data.lon.toFixed(5)})`;

    // MAP UPDATE
    if (!map) {
      initMap(data.lat, data.lon);
    } else {
      senderMarker.setLatLng([data.lat, data.lon]);
      map.panTo([data.lat, data.lon]);
    }

    // Distance (if viewer location allowed)
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos => {
        const d = getDistance(
          pos.coords.latitude,
          pos.coords.longitude,
          data.lat,
          data.lon
        );

        document.getElementById("distance").innerText =
          "üìè Distance: " + (d < 1000
            ? d.toFixed(0) + " m"
            : (d / 1000).toFixed(2) + " km");
      });
    }

  } catch (err) {
    console.error("Invalid data", err);
  }
};

ws.onopen = () => {
  console.log("Viewer WebSocket connected");
};
</script>

</body>
</html>
