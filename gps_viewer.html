<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>GPS Viewer</title>

<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body {
  margin:0;
  background:#111;
  color:#eee;
  font-family:Arial;
}
#top {
  padding:10px;
  text-align:center;
}
#map {
  height:80vh;
}
</style>
</head>

<body>

<div id="top">
  <h2>ðŸ‘€ GPS Viewer</h2>
  Pair Code:
  <input id="pair" value="AB1234">
  <p id="last">Waiting for dataâ€¦</p>
</div>

<div id="map"></div>

<script>
const ws = new WebSocket("wss://ws-relay-zqzk.onrender.com");

const map = L.map("map").setView([11.0,78.0], 13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom:19
}).addTo(map);

let marker = null;

ws.onmessage = e => {
  const data = JSON.parse(e.data);
  const pair = document.getElementById("pair").value.trim();

  if (data.pair !== pair) return;

  // GPS update
  if (data.type === "gps") {
    const lat = data.lat;
    const lon = data.lon;

    if (!marker) {
      marker = L.marker([lat, lon]).addTo(map);
    } else {
      marker.setLatLng([lat, lon]);
    }

    map.setView([lat, lon], 16);
    document.getElementById("last").innerText =
      "Last update: " + new Date(data.ts).toLocaleTimeString();
  }

  // SOS popup
  if (data.type === "sos") {
    alert("ðŸš¨ SOS ALERT RECEIVED!\nImmediate attention required.");
  }
};
</script>

</body>
</html>
