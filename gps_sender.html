<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>GPS Sender</title>

<style>
body{background:#111;color:#eee;font-family:Arial;text-align:center;padding:10px}
input,button{padding:8px;margin:5px;font-size:15px}
#pair{font-weight:bold;letter-spacing:2px}
#chat{height:140px;overflow:auto;border:1px solid #333;padding:5px}
.me{color:#0f0}
.them{color:#6cf}
#sos{
  position:fixed;bottom:18px;left:50%;
  transform:translateX(-50%);
  background:red;color:white;
  font-size:20px;font-weight:bold;
  border:none;border-radius:40px;
  padding:14px 32px;
}
</style>
</head>

<body>

<h2>ğŸ“ GPS Sender</h2>

Pair Code:
<input id="pair" readonly><br>

<button onclick="startGPS()">Start GPS</button>
<button onclick="stopGPS()">Stop GPS</button>
<button onclick="recordVoice()">ğŸ™ï¸ Voice (10s)</button>

<p id="status">Idle</p>

<h3>ğŸ’¬ Chat</h3>
<div id="chat"></div>
<input id="msg" placeholder="Type message">
<button onclick="sendText()">Send</button>

<button id="sos" onclick="sendSOS()">ğŸš¨ SOS</button>

<script>
const ws=new WebSocket("wss://ws-relay-zqzk.onrender.com");
let watchId=null,mediaRecorder,chunks=[];

// generate secure pair
const pairCode=Math.random().toString(36).substring(2,8).toUpperCase();
pair.value=pairCode;

function log(cls,text){
  chat.innerHTML+=`<div class="${cls}">${text}</div>`;
  chat.scrollTop=chat.scrollHeight;
}

ws.onopen=()=>log("them","System connected");

function send(o){ws.send(JSON.stringify(o));}

// GPS
function startGPS(){
  watchId=navigator.geolocation.watchPosition(p=>{
    send({type:"gps",pair:pairCode,lat:p.coords.latitude,lon:p.coords.longitude,ts:Date.now()});
    status.innerText="Sharing GPS";
  },()=>alert("GPS error"),{enableHighAccuracy:true});
}
function stopGPS(){
  if(watchId) navigator.geolocation.clearWatch(watchId);
  status.innerText="Stopped";
}

// Chat
function sendText(){
  if(!msg.value)return;
  send({type:"text",from:"sender",pair:pairCode,text:msg.value,ts:Date.now()});
  log("me","Me: "+msg.value);
  msg.value="";
}

// SOS
function sendSOS(){
  send({type:"sos",pair:pairCode,ts:Date.now()});
  alert("ğŸš¨ SOS sent");
}

// Voice
async function recordVoice(){
  const stream=await navigator.mediaDevices.getUserMedia({audio:true});
  mediaRecorder=new MediaRecorder(stream);
  chunks=[];
  mediaRecorder.ondataavailable=e=>chunks.push(e.data);
  mediaRecorder.onstop=()=>{
    const b=new Blob(chunks,{type:"audio/webm"});
    const r=new FileReader();
    r.onloadend=()=>send({type:"audio",pair:pairCode,audio:r.result,ts:Date.now()});
    r.readAsDataURL(b);
  };
  mediaRecorder.start();
  setTimeout(()=>mediaRecorder.stop(),10000);
}

// RECEIVE
ws.onmessage=e=>{
  const d=JSON.parse(e.data);
  if(d.type==="pair_check"){
    send({type:"pair_result",pair:d.pair,status:(d.pair===pairCode?"success":"failed")});
  }
  if(d.type==="text" && d.from==="viewer") log("them","Viewer: "+d.text);
  if(d.type==="ack") log("them","SOS acknowledged");
};
</script>
</body>
</html>
