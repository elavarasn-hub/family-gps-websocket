<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Hybrid Location Sender</title>

<style>
body{
  background:#111;color:#eee;
  font-family:Arial;text-align:center;
  padding:20px;
}
input,button{
  padding:10px;font-size:16px;margin:6px;
}
</style>
</head>

<body>

<h2>üìç LOCATION SENDER</h2>

Pair Code:<br>
<input id="pair" placeholder="Enter pair code"><br>

<button onclick="sendLocation()">Send Location</button>

<p id="status">Idle</p>

<script>
const ws = new WebSocket("wss://ws-relay-zqzk.onrender.com");

function sendLocation(){
  const pair = document.getElementById("pair").value.trim();
  if(!pair){
    alert("Enter pair code");
    return;
  }

  if(!navigator.geolocation){
    alert("Location not supported");
    return;
  }

  document.getElementById("status").innerText = "Getting location‚Ä¶";

  navigator.geolocation.getCurrentPosition(
    pos => {
      send(pos.coords.latitude, pos.coords.longitude, pos.coords.accuracy, pair);
    },
    err => {
      // üîÅ SILENT FALLBACK (NO ERROR SHOWN)
      fallbackNetwork(pair);
    },
    {
      enableHighAccuracy: false,   // üîë DO NOT FORCE GPS
      timeout: 30000,              // long wait
      maximumAge: 60000            // reuse cached
    }
  );
}

function fallbackNetwork(pair){
  fetch("https://ipapi.co/json/")
    .then(r=>r.json())
    .then(loc=>{
      send(loc.latitude, loc.longitude, 1000, pair);
    })
    .catch(()=>{
      document.getElementById("status").innerText = "Location unavailable";
    });
}

function send(lat, lon, acc, pair){
  if(ws.readyState!==WebSocket.OPEN){
    document.getElementById("status").innerText="WS not ready";
    return;
  }

  ws.send(JSON.stringify({
    pair: pair,
    lat: lat,
    lon: lon,
    acc: Math.round(acc),
    ts: Date.now()
  }));

  document.getElementById("status").innerText =
    "Sent | Accuracy ‚âà " + Math.round(acc) + " m";
}
</script>

</body>
</html>
